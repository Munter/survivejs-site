<html lang="en"><head><title>SurviveJS - React and Flux</title><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimal-ui"/><meta name="description" content="
You can get pretty far by keeping everything in components. Eventually, that will become painful. Flux application architecture helps to bring clarity to our React applications.

Flux will allow us to separate data and application state from our views. This helps us to keep them clean and the appliâ€¦"/><meta name="keywords" content="webpack,react,javascript,programming,web development"/><link rel="icon" type="image/png" href="/assets/img/favicon.png"/><link rel="alternate" type="application/atom+xml" href="./atom.xml"/><link rel="stylesheet" href="/assets/main.css"/></head><body><main role="main"><div class="chapter__wrapper"><div class="header-image" style="background-image:url(/images/delorean.jpg);"></div><h1 class="post__heading">React and Flux</h1><div class="header-extra"><a href="https://www.flickr.com/photos/126433814@N04/16298563416">jeremyg3030 (CC BY)</a></div><div class="toc-nav__wrapper"><h4 class="toc-nav--header">Table of Contents</h4><div class="toc-nav"><a class="toc-nav__link chapter" href="/webpack_react/introduction">Introduction</a><a class="toc-nav__link part" href="/webpack_react/webpack">Setting Up Webpack</a><a class="toc-nav__link chapter" href="/webpack_react/webpack_compared">Webpack Compared</a><a class="toc-nav__link chapter" href="/webpack_react/developing_with_webpack">Developing with Webpack</a><a class="toc-nav__link chapter" href="/webpack_react/webpack_and_react">Webpack and React</a><a class="toc-nav__link part" href="/webpack_react/react">Developing Kanban Application</a><a class="toc-nav__link chapter" href="/webpack_react/implementing_notes">Implementing a Basic Note Application</a><span class="toc-nav__link toc-nav__link--current chapter">React and Flux</span><a class="toc-nav__link chapter" href="/webpack_react/from_notes_to_kanban">From Notes to Kanban</a><a class="toc-nav__link chapter" href="/webpack_react/implementing_dnd">Implementing Drag and Drop</a><a class="toc-nav__link chapter" href="/webpack_react/building_kanban">Building Kanban</a><a class="toc-nav__link part" href="/webpack_react/advanced">Advanced Techniques</a><a class="toc-nav__link chapter" href="/webpack_react/testing_react">Testing React*</a><a class="toc-nav__link chapter" href="/webpack_react/typing_with_react">Typing with React*</a><a class="toc-nav__link chapter" href="/webpack_react/linting_in_webpack">Linting in Webpack</a><a class="toc-nav__link chapter" href="/webpack_react/authoring_libraries">Authoring Libraries</a><a class="toc-nav__link chapter" href="/webpack_react/styling_react">Styling React</a><a class="toc-nav__link part" href="/webpack_react/appendices">Appendices</a><a class="toc-nav__link chapter" href="/webpack_react/structuring_react_projects">Structuring React Projects</a><a class="toc-nav__link chapter" href="/webpack_react/language_features">Language Features</a><a class="toc-nav__link chapter" href="/webpack_react/understanding_decorators">Understanding Decorators</a><a class="toc-nav__link chapter" href="/webpack_react/troubleshooting">Troubleshooting</a></div></div><div class="chapter"><div class="post__content"><blockquote class="front__latestpost tip"><div>From the blog:</div><a class="front__latestpost-link" href="/blog/towards-common-components">Towards a Common Component Definition</a></blockquote><div class="post__meta"><a class="post__start_source" href="https://github.com/survivejs/webpack_react/tree/master/project_source/04_implementing_notes/kanban_app" target="_blank">Start source code</a><a class="post__end_source" href="https://github.com/survivejs/webpack_react/tree/master/project_source/05_react_and_flux/kanban_app" target="_blank">Finished source code</a><a class="post__demo" href="/demos/05_react_and_flux" target="_blank">Demo</a></div><div class="chapter-content"><p>You can get pretty far by keeping everything in components. Eventually, that will become painful. <a href="https://facebook.github.io/flux/docs/overview.html">Flux application architecture</a> helps to bring clarity to our React applications.</p>
<p>Flux will allow us to separate data and application state from our views. This helps us to keep them clean and the application maintainable. Flux was designed with large teams in mind. As a result, you might find it quite verbose. This comes with great advantages, though, as it can be straightforward to work with.</p>
<h2 class="header"><a class="header-anchor" href="#introduction-to-flux" id="introduction-to-flux"></a><span class="text">Introduction to Flux</span><a class="header-anchor-select" href="#introduction-to-flux">#</a></h2>
<p><img src="/images/flux_linear.png" alt="Unidirectional Flux dataflow"></p>
<p>So far, we&#39;ve been dealing only with views. Flux architecture introduces a couple of new concepts to the mix. These are actions, dispatcher, and stores. Flux implements unidirectional flow in contrast to popular frameworks, such as Angular or Ember. Even though two-directional bindings can be convenient, they come with a cost. It can be hard to deduce what&#39;s going on and why.</p>
<h3 class="header"><a class="header-anchor" href="#actions-and-stores" id="actions-and-stores"></a><span class="text">Actions and Stores</span><a class="header-anchor-select" href="#actions-and-stores">#</a></h3>
<p>Flux isn&#39;t entirely simple to understand as there are many concepts to worry about. In our case, we will model <code>NoteActions</code> and <code>NoteStore</code>. <code>NoteActions</code> provide concrete operations we can perform over our data. For instance, we can have <code>NoteActions.create({task: &#39;Learn React&#39;})</code>.</p>
<h3 class="header"><a class="header-anchor" href="#dispatcher" id="dispatcher"></a><span class="text">Dispatcher</span><a class="header-anchor-select" href="#dispatcher">#</a></h3>
<p>When we trigger the action, the dispatcher will get notified. The dispatcher will be able to deal with possible dependencies between stores. It is possible that a certain action needs to happen before another. The dispatcher allows us to achieve this.</p>
<p>At the simplest level, actions can just pass the message to the dispatcher as is. They can also trigger asynchronous queries and hit the dispatcher based on the result eventually. This allows us to deal with received data and possible errors.</p>
<p>Once the dispatcher has dealt with the action, stores that are listening to it get triggered. In our case, <code>NoteStore</code> gets notified. As a result, it will be able to update its internal state. After doing this it will notify possible listeners of the new state.</p>
<h3 class="header"><a class="header-anchor" href="#flux-dataflow" id="flux-dataflow"></a><span class="text">Flux Dataflow</span><a class="header-anchor-select" href="#flux-dataflow">#</a></h3>
<p>This completes the basic unidirectional, yet linear, process flow of Flux. Usually, though, the unidirectional process has a cyclical flow and it doesn&#39;t necessarily end. The following diagram illustrates a more common flow. It is the same idea again, but with the addition of a returning cycle. Eventually, the components depending on our store data become refreshed through this looping process.</p>
<p>This sounds like a lot of steps for achieving something simple as creating a new <code>Note</code>. The approach does come with its benefits. Given the flow is always in a single direction, it is easy to trace and debug. If there&#39;s something wrong, it&#39;s somewhere within the cycle.</p>
<p><img src="/images/flux.png" alt="Flux dataflow with cycle"></p>
<h3 class="header"><a class="header-anchor" href="#advantages-of-flux" id="advantages-of-flux"></a><span class="text">Advantages of Flux</span><a class="header-anchor-select" href="#advantages-of-flux">#</a></h3>
<p>Even though this sounds a little complicated, the arrangement gives our application flexibility. We can, for instance, implement API communication, caching, and i18n outside of our views. This way they stay clean of logic while keeping the application easier to understand.</p>
<p>Implementing Flux architecture in your application will actually increase the amount of code somewhat. It is important to understand: minimizing the amount of code written isn&#39;t the goal of Flux. It has been designed to allow productivity across larger teams. You could say, &quot;explicit is better than implicit&quot;.</p>
<h3 class="header"><a class="header-anchor" href="#which-flux-implementation-to-use-" id="which-flux-implementation-to-use-"></a><span class="text">Which Flux Implementation to Use?</span><a class="header-anchor-select" href="#which-flux-implementation-to-use-">#</a></h3>
<p>The library situation is constantly changing. There is no single right way to interpret the architecture. You will find implementations that fit different tastes. <a href="https://github.com/voronianski/flux-comparison">voronianski/flux-comparison</a> provides a nice comparison between some of the more popular ones.</p>
<p>When choosing a library, it comes down to your own personal preferences. You will have to consider factors, such as API, features, documentation, and support. Starting with one of the more popular alternatives can be a good idea. As you begin to understand the architecture, you are able to make choices that serve you better.</p>
<blockquote class="tip"><a href="http://rackt.org/redux/">Redux</a> has taken the core ideas of Flux and pushed them into a tiny form (2 kB). Despite this, it&#39;s quite powerful approach and worth checking out.</blockquote><h2 class="header"><a class="header-anchor" href="#porting-to-alt" id="porting-to-alt"></a><span class="text">Porting to Alt</span><a class="header-anchor-select" href="#porting-to-alt">#</a></h2>
<p><img src="/images/alt.png" alt="Alt"></p>
<p>In this chapter, we&#39;ll be using a library known as <a href="http://alt.js.org/">Alt</a>. It is a flexible, full-featured implementation that has been designed with universal (isomorphic) rendering in mind.</p>
<p>In Alt, you&#39;ll deal with actions and stores. The dispatcher is hidden, but you will still have access to it if needed. Compared to other implementations Alt hides a lot of boilerplate. There are special features to allow you to save and restore the application state. This is handy for implementing persistency and universal rendering.</p>
<h3 class="header"><a class="header-anchor" href="#setting-up-an-alt-instance" id="setting-up-an-alt-instance"></a><span class="text">Setting Up an Alt Instance</span><a class="header-anchor-select" href="#setting-up-an-alt-instance">#</a></h3>
<p>Everything in Alt begins from an Alt instance. It keeps track of actions and stores and keeps communication going on. To get started, we should add Alt to our project. We&#39;ll also install <em>alt-utils</em> as it contains some special functionality we&#39;ll need later on:</p>
<pre><code class="lang-bash">npm i alt alt-utils --save
</code></pre>
<p>To keep things simple, we&#39;ll be treating all Alt components as a <a href="https://en.wikipedia.org/wiki/Singleton_pattern">singleton</a>. With this pattern, we reuse the same instance within the whole application. To achieve this we can push it to a module of its own and then refer to that from everywhere. Set it up as follows:</p>
<p><strong>app/libs/alt.js</strong></p>
<pre><code class="lang-javascript"><span class="token keyword" >import</span> Alt <span class="token keyword" >from</span> <span class="token string" >'alt'</span><span class="token punctuation" >;</span>
<span class="token comment" spellcheck="true">//import chromeDebug from 'alt-utils/lib/chromeDebug';</span>

<span class="token keyword" >const</span> alt <span class="token operator" >=</span> <span class="token keyword" >new</span> <span class="token class-name" >Alt</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
<span class="token comment" spellcheck="true">//chromeDebug(alt);</span>

<span class="token keyword" >export</span> <span class="token keyword" >default</span> alt<span class="token punctuation" >;</span>
</code></pre>
<p>Webpack caches the modules so the next time you import Alt, it will return the same instance again.</p>
<blockquote class="tip">There is a Chrome plugin known as <a href="https://github.com/goatslacker/alt-devtool">alt-devtool</a>. After it is installed, you can connect to Alt by uncommenting the related lines above. You can use it to debug the state of your stores, search, and travel in time.</blockquote><h3 class="header"><a class="header-anchor" href="#defining-crud-api-for-notes" id="defining-crud-api-for-notes"></a><span class="text">Defining CRUD API for Notes</span><a class="header-anchor-select" href="#defining-crud-api-for-notes">#</a></h3>
<p>Next, we&#39;ll need to define a basic API for operating over the Note data. To keep this simple, we can CRUD (Create, Read, Update, Delete) it. Given Read is implicit, we won&#39;t be needing that. We can model the rest as actions, though. Alt provides a shorthand known as <code>generateActions</code>. We can use it like this:</p>
<p><strong>app/actions/NoteActions.js</strong></p>
<pre><code class="lang-javascript"><span class="token keyword" >import</span> alt <span class="token keyword" >from</span> <span class="token string" >'../libs/alt'</span><span class="token punctuation" >;</span>

<span class="token keyword" >export</span> <span class="token keyword" >default</span> alt<span class="token punctuation" >.</span><span class="token function" >generateActions</span><span class="token punctuation" >(</span><span class="token string" >'create'</span><span class="token punctuation" >,</span> <span class="token string" >'update'</span><span class="token punctuation" >,</span> <span class="token string" >'delete'</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
</code></pre>
<h2 class="header"><a class="header-anchor" href="#defining-a-store-for-notes-" id="defining-a-store-for-notes-"></a><span class="text">Defining a Store for <code>Notes</code></span><a class="header-anchor-select" href="#defining-a-store-for-notes-">#</a></h2>
<p>A store is a single source of truth for a part of your application state. In this case, we need one to maintain the state of the notes. We will connect all the actions we defined above using the <code>bindActions</code> function.</p>
<p>We have the logic we need for our store already at <code>App</code>. We will move that logic to <code>NoteStore</code>.</p>
<h3 class="header"><a class="header-anchor" href="#setting-up-a-skeleton" id="setting-up-a-skeleton"></a><span class="text">Setting Up a Skeleton</span><a class="header-anchor-select" href="#setting-up-a-skeleton">#</a></h3>
<p>As a first step, we can set up a skeleton for our store. We can fill in the methods we need after that. Alt uses standard ES6 classes, so it&#39;s the same syntax as we saw earlier with React components. Here&#39;s a starting point:</p>
<p><strong>app/stores/NoteStore.js</strong></p>
<pre><code class="lang-javascript"><span class="token keyword" >import</span> uuid <span class="token keyword" >from</span> <span class="token string" >'node-uuid'</span><span class="token punctuation" >;</span>
<span class="token keyword" >import</span> alt <span class="token keyword" >from</span> <span class="token string" >'../libs/alt'</span><span class="token punctuation" >;</span>
<span class="token keyword" >import</span> NoteActions <span class="token keyword" >from</span> <span class="token string" >'../actions/NoteActions'</span><span class="token punctuation" >;</span>

<span class="token keyword" >class</span> <span class="token class-name" >NoteStore</span> <span class="token punctuation" >{</span>
  <span class="token function" >constructor</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
    <span class="token keyword" >this</span><span class="token punctuation" >.</span><span class="token function" >bindActions</span><span class="token punctuation" >(</span>NoteActions<span class="token punctuation" >)</span><span class="token punctuation" >;</span>

    <span class="token keyword" >this</span><span class="token punctuation" >.</span>notes <span class="token operator" >=</span> <span class="token punctuation" >[</span><span class="token punctuation" >]</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span>
  <span class="token function" >create</span><span class="token punctuation" >(</span>note<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>

  <span class="token punctuation" >}</span>
  <span class="token function" >update</span><span class="token punctuation" >(</span>updatedNote<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>

  <span class="token punctuation" >}</span>
  <span class="token keyword" >delete</span><span class="token punctuation" >(</span>id<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>

  <span class="token punctuation" >}</span>
<span class="token punctuation" >}</span>

<span class="token keyword" >export</span> <span class="token keyword" >default</span> alt<span class="token punctuation" >.</span><span class="token function" >createStore</span><span class="token punctuation" >(</span>NoteStore<span class="token punctuation" >,</span> <span class="token string" >'NoteStore'</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
</code></pre>
<p>We call <code>bindActions</code> to map each action to a method by name. We trigger the appropriate logic at each method based on that. Finally, we connect the store with Alt using <code>alt.createStore</code>.</p>
<p>Note that assigning a label to a store (<code>NoteStore</code> in this case) isn&#39;t required. It is a good practice as it protects the code against minification and possible collisions. These labels become important when we persist the data.</p>
<h3 class="header"><a class="header-anchor" href="#implementing-create-" id="implementing-create-"></a><span class="text">Implementing <code>create</code></span><a class="header-anchor-select" href="#implementing-create-">#</a></h3>
<p>Compared to the earlier logic, <code>create</code> will generate an id for a <code>Note</code> automatically. This is a detail that can be hidden within the store:</p>
<p><strong>app/stores/NoteStore.js</strong></p>
<pre><code class="lang-javascript"><span class="token keyword" >import</span> uuid <span class="token keyword" >from</span> <span class="token string" >'node-uuid'</span><span class="token punctuation" >;</span>
<span class="token keyword" >import</span> alt <span class="token keyword" >from</span> <span class="token string" >'../libs/alt'</span><span class="token punctuation" >;</span>
<span class="token keyword" >import</span> NoteActions <span class="token keyword" >from</span> <span class="token string" >'../actions/NoteActions'</span><span class="token punctuation" >;</span>

<span class="token keyword" >class</span> <span class="token class-name" >NoteStore</span> <span class="token punctuation" >{</span>
  <span class="token function" >constructor</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
    <span class="token punctuation" >.</span><span class="token punctuation" >.</span><span class="token punctuation" >.</span>
  <span class="token punctuation" >}</span>
  <span class="token function" >create</span><span class="token punctuation" >(</span>note<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
<div class="leanpub-insert">
    <span class="token keyword" >const</span> notes <span class="token operator" >=</span> <span class="token keyword" >this</span><span class="token punctuation" >.</span>notes<span class="token punctuation" >;</span>

    note<span class="token punctuation" >.</span>id <span class="token operator" >=</span> uuid<span class="token punctuation" >.</span><span class="token function" >v4</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>

    <span class="token keyword" >this</span><span class="token punctuation" >.</span><span class="token function" >setState</span><span class="token punctuation" >(</span><span class="token punctuation" >{</span>
      notes<span class="token punctuation" >:</span> notes<span class="token punctuation" >.</span><span class="token function" >concat</span><span class="token punctuation" >(</span>note<span class="token punctuation" >)</span>
    <span class="token punctuation" >}</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
</div>
  <span class="token punctuation" >}</span>
  <span class="token punctuation" >.</span><span class="token punctuation" >.</span><span class="token punctuation" >.</span>
<span class="token punctuation" >}</span>

<span class="token keyword" >export</span> <span class="token keyword" >default</span> alt<span class="token punctuation" >.</span><span class="token function" >createStore</span><span class="token punctuation" >(</span>NoteStore<span class="token punctuation" >,</span> <span class="token string" >'NoteStore'</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
</code></pre>
<p>To keep the implementation clean, we are using <code>this.setState</code>. It is a feature of Alt that allows us to signify that we are going to alter the store state. Alt will signal the change to possible listeners.</p>
<h3 class="header"><a class="header-anchor" href="#implementing-update-" id="implementing-update-"></a><span class="text">Implementing <code>update</code></span><a class="header-anchor-select" href="#implementing-update-">#</a></h3>
<p><code>update</code> follows the earlier logic apart from some renaming. Most importantly we commit the new state through <code>this.setState</code>:</p>
<p><strong>app/stores/NoteStore.js</strong></p>
<pre><code class="lang-javascript"><span class="token punctuation" >.</span><span class="token punctuation" >.</span><span class="token punctuation" >.</span>

<span class="token keyword" >class</span> <span class="token class-name" >NoteStore</span> <span class="token punctuation" >{</span>
  <span class="token punctuation" >.</span><span class="token punctuation" >.</span><span class="token punctuation" >.</span>
  <span class="token function" >update</span><span class="token punctuation" >(</span>updatedNote<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
<div class="leanpub-insert">
    <span class="token keyword" >const</span> notes <span class="token operator" >=</span> <span class="token keyword" >this</span><span class="token punctuation" >.</span>notes<span class="token punctuation" >.</span><span class="token function" >map</span><span class="token punctuation" >(</span>note <span class="token operator" >=</span><span class="token operator" >></span> <span class="token punctuation" >{</span>
      <span class="token keyword" >if</span><span class="token punctuation" >(</span>note<span class="token punctuation" >.</span>id <span class="token operator" >===</span> updatedNote<span class="token punctuation" >.</span>id<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
        <span class="token keyword" >return</span> Object<span class="token punctuation" >.</span><span class="token function" >assign</span><span class="token punctuation" >(</span><span class="token punctuation" >{</span><span class="token punctuation" >}</span><span class="token punctuation" >,</span> note<span class="token punctuation" >,</span> updatedNote<span class="token punctuation" >)</span><span class="token punctuation" >;</span>
      <span class="token punctuation" >}</span>

      <span class="token keyword" >return</span> note<span class="token punctuation" >;</span>
    <span class="token punctuation" >}</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>

    <span class="token comment" spellcheck="true">// This is same as `this.setState({notes: notes})`</span>
    <span class="token keyword" >this</span><span class="token punctuation" >.</span><span class="token function" >setState</span><span class="token punctuation" >(</span><span class="token punctuation" >{</span>notes<span class="token punctuation" >}</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
</div>
  <span class="token punctuation" >}</span>
  <span class="token keyword" >delete</span><span class="token punctuation" >(</span>id<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>

  <span class="token punctuation" >}</span>
<span class="token punctuation" >}</span>

<span class="token keyword" >export</span> <span class="token keyword" >default</span> alt<span class="token punctuation" >.</span><span class="token function" >createStore</span><span class="token punctuation" >(</span>NoteStore<span class="token punctuation" >,</span> <span class="token string" >'NoteStore'</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
</code></pre>
<p>We have one final operation left, <code>delete</code>.</p>
<blockquote class="tip"><code>{notes}</code> is known as a an ES6 feature known as <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Object_initializer">property shorthand</a>. This is equivalent to <code>{notes: notes}</code>.</blockquote><h3 class="header"><a class="header-anchor" href="#implementing-delete-" id="implementing-delete-"></a><span class="text">Implementing <code>delete</code></span><a class="header-anchor-select" href="#implementing-delete-">#</a></h3>
<p><code>delete</code> is straightforward. Seek and destroy, as earlier, and remember to commit the change:</p>
<p><strong>app/stores/NoteStore.js</strong></p>
<pre><code class="lang-javascript"><span class="token punctuation" >.</span><span class="token punctuation" >.</span><span class="token punctuation" >.</span>

<span class="token keyword" >class</span> <span class="token class-name" >NoteStore</span> <span class="token punctuation" >{</span>
  <span class="token punctuation" >.</span><span class="token punctuation" >.</span><span class="token punctuation" >.</span>
  <span class="token keyword" >delete</span><span class="token punctuation" >(</span>id<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
<div class="leanpub-insert">
    <span class="token keyword" >this</span><span class="token punctuation" >.</span><span class="token function" >setState</span><span class="token punctuation" >(</span><span class="token punctuation" >{</span>
      notes<span class="token punctuation" >:</span> <span class="token keyword" >this</span><span class="token punctuation" >.</span>notes<span class="token punctuation" >.</span><span class="token function" >filter</span><span class="token punctuation" >(</span>note <span class="token operator" >=</span><span class="token operator" >></span> note<span class="token punctuation" >.</span>id <span class="token operator" >!==</span> id<span class="token punctuation" >)</span>
    <span class="token punctuation" >}</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
</div>
  <span class="token punctuation" >}</span>
<span class="token punctuation" >}</span>

<span class="token keyword" >export</span> <span class="token keyword" >default</span> alt<span class="token punctuation" >.</span><span class="token function" >createStore</span><span class="token punctuation" >(</span>NoteStore<span class="token punctuation" >,</span> <span class="token string" >'NoteStore'</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
</code></pre>
<p>Instead of slicing and concatenating data, it would be possible to operate directly on it. For example a mutable variant, such as <code>this.notes.splice(targetId, 1)</code> would work. We could also use a shorthand, such as <code>[...notes.slice(0, noteIndex), ...notes.slice(noteIndex + 1)]</code>. The exact solution depends on your preferences. I prefer to avoid mutable solutions (i.e., <code>splice</code>) myself.</p>
<p>It is recommended that you use <code>setState</code> with Alt to keep things clean and easy to understand. Manipulating <code>this.notes</code> directly would work, but that would miss the intent and could become problematic in larger scale as mutation is difficult to debug. <code>setState</code> provides a nice analogue to the way React works so it&#39;s worth using.</p>
<p>We have almost integrated Flux with our application now. We have a set of actions that provide an API for manipulating <code>Notes</code> data. We also have a store for actual data manipulation. We are missing one final bit, integration with our view. It will have to listen to the store and be able to trigger actions to complete the cycle.</p>
<blockquote class="tip">The current implementation is naÃ¯ve in that it doesn&#39;t validate parameters in any way. It would be a very good idea to validate the object shape to avoid incidents during development. <a href="http://flowtype.org/">Flow</a> based gradual typing provides one way to do this. Alternatively you could write nice tests. That&#39;s a good idea regardless.</blockquote><h2 class="header"><a class="header-anchor" href="#gluing-it-all-together" id="gluing-it-all-together"></a><span class="text">Gluing It All Together</span><a class="header-anchor-select" href="#gluing-it-all-together">#</a></h2>
<p>Gluing this all together is a little complicated as there are multiple concerns to take care of. Dealing with actions is going to be easy. For instance, to create a Note, we would need to trigger <code>NoteActions.create({task: &#39;New task&#39;})</code>. That would cause the associated store to change and, as a result, all the components listening to it.</p>
<p>Our <code>NoteStore</code> provides two methods in particular that are going to be useful. These are <code>NoteStore.listen</code> and <code>NoteStore.unlisten</code>. They will allow views to subscribe to the state changes.</p>
<p>As you might remember from the earlier chapters, React provides a set of lifecycle hooks. We can subscribe to <code>NoteStore</code> within our view at <code>componentDidMount</code> and <code>componentWillUnmount</code>. By unsubscribing, we avoid possible memory leaks.</p>
<p>Based on these ideas we can connect <code>App</code> with <code>NoteStore</code> and <code>NoteActions</code>:</p>
<p><strong>app/components/App.jsx</strong></p>
<pre><code class="lang-javascript"><div class="leanpub-delete">
<span class="token keyword" >import</span> uuid <span class="token keyword" >from</span> <span class="token string" >'node-uuid'</span><span class="token punctuation" >;</span>
</div>
<span class="token keyword" >import</span> React <span class="token keyword" >from</span> <span class="token string" >'react'</span><span class="token punctuation" >;</span>
<span class="token keyword" >import</span> Notes <span class="token keyword" >from</span> <span class="token string" >'./Notes.jsx'</span><span class="token punctuation" >;</span>
<div class="leanpub-insert">
<span class="token keyword" >import</span> NoteActions <span class="token keyword" >from</span> <span class="token string" >'../actions/NoteActions'</span><span class="token punctuation" >;</span>
<span class="token keyword" >import</span> NoteStore <span class="token keyword" >from</span> <span class="token string" >'../stores/NoteStore'</span><span class="token punctuation" >;</span>
</div>

<span class="token keyword" >export</span> <span class="token keyword" >default</span> <span class="token keyword" >class</span> <span class="token class-name" >App</span> <span class="token keyword" >extends</span> <span class="token class-name" >React<span class="token punctuation" >.</span>Component</span> <span class="token punctuation" >{</span>
  <span class="token function" >constructor</span><span class="token punctuation" >(</span>props<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
    <span class="token keyword" >super</span><span class="token punctuation" >(</span>props<span class="token punctuation" >)</span><span class="token punctuation" >;</span>

<div class="leanpub-delete">
    <span class="token keyword" >this</span><span class="token punctuation" >.</span>state <span class="token operator" >=</span> <span class="token punctuation" >{</span>
      notes<span class="token punctuation" >:</span> <span class="token punctuation" >[</span>
        <span class="token punctuation" >{</span>
          id<span class="token punctuation" >:</span> uuid<span class="token punctuation" >.</span><span class="token function" >v4</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span><span class="token punctuation" >,</span>
          task<span class="token punctuation" >:</span> <span class="token string" >'Learn Webpack'</span>
        <span class="token punctuation" >}</span><span class="token punctuation" >,</span>
        <span class="token punctuation" >{</span>
          id<span class="token punctuation" >:</span> uuid<span class="token punctuation" >.</span><span class="token function" >v4</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span><span class="token punctuation" >,</span>
          task<span class="token punctuation" >:</span> <span class="token string" >'Learn React'</span>
        <span class="token punctuation" >}</span><span class="token punctuation" >,</span>
        <span class="token punctuation" >{</span>
          id<span class="token punctuation" >:</span> uuid<span class="token punctuation" >.</span><span class="token function" >v4</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span><span class="token punctuation" >,</span>
          task<span class="token punctuation" >:</span> <span class="token string" >'Do laundry'</span>
        <span class="token punctuation" >}</span>
      <span class="token punctuation" >]</span>
    <span class="token punctuation" >}</span><span class="token punctuation" >;</span>
</div>
<div class="leanpub-insert">
    <span class="token keyword" >this</span><span class="token punctuation" >.</span>state <span class="token operator" >=</span> NoteStore<span class="token punctuation" >.</span><span class="token function" >getState</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
</div>
  <span class="token punctuation" >}</span>
<div class="leanpub-insert">
  <span class="token function" >componentDidMount</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
    NoteStore<span class="token punctuation" >.</span><span class="token function" >listen</span><span class="token punctuation" >(</span><span class="token keyword" >this</span><span class="token punctuation" >.</span>storeChanged<span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span>
  <span class="token function" >componentWillUnmount</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
    NoteStore<span class="token punctuation" >.</span><span class="token function" >unlisten</span><span class="token punctuation" >(</span><span class="token keyword" >this</span><span class="token punctuation" >.</span>storeChanged<span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span>
  storeChanged <span class="token operator" >=</span> <span class="token punctuation" >(</span>state<span class="token punctuation" >)</span> <span class="token operator" >=</span><span class="token operator" >></span> <span class="token punctuation" >{</span>
    <span class="token comment" spellcheck="true">// Without a property initializer `this` wouldn't</span>
    <span class="token comment" spellcheck="true">// point at the right context because it defaults to</span>
    <span class="token comment" spellcheck="true">// `undefined` in strict mode.</span>
    <span class="token keyword" >this</span><span class="token punctuation" >.</span><span class="token function" >setState</span><span class="token punctuation" >(</span>state<span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span><span class="token punctuation" >;</span>
</div>
  <span class="token function" >render</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
    <span class="token keyword" >const</span> notes <span class="token operator" >=</span> <span class="token keyword" >this</span><span class="token punctuation" >.</span>state<span class="token punctuation" >.</span>notes<span class="token punctuation" >;</span>

    <span class="token keyword" >return</span> <span class="token punctuation" >(</span>
      <span class="token operator" >&lt;</span>div<span class="token operator" >></span>
        <span class="token operator" >&lt;</span>button className<span class="token operator" >=</span><span class="token string" >"add-note"</span> onClick<span class="token operator" >=</span><span class="token punctuation" >{</span><span class="token keyword" >this</span><span class="token punctuation" >.</span>addNote<span class="token punctuation" >}</span><span class="token operator" >></span><span class="token operator" >+</span><span class="token operator" >&lt;</span><span class="token operator" >/</span>button<span class="token operator" >></span>
        <span class="token operator" >&lt;</span>Notes notes<span class="token operator" >=</span><span class="token punctuation" >{</span>notes<span class="token punctuation" >}</span>
          onEdit<span class="token operator" >=</span><span class="token punctuation" >{</span><span class="token keyword" >this</span><span class="token punctuation" >.</span>editNote<span class="token punctuation" >}</span>
          onDelete<span class="token operator" >=</span><span class="token punctuation" >{</span><span class="token keyword" >this</span><span class="token punctuation" >.</span>deleteNote<span class="token punctuation" >}</span> <span class="token operator" >/</span><span class="token operator" >></span>
      <span class="token operator" >&lt;</span><span class="token operator" >/</span>div<span class="token operator" >></span>
    <span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span>
<div class="leanpub-delete">
  deleteNote <span class="token operator" >=</span> <span class="token punctuation" >(</span>id<span class="token punctuation" >)</span> <span class="token operator" >=</span><span class="token operator" >></span> <span class="token punctuation" >{</span>
    <span class="token keyword" >this</span><span class="token punctuation" >.</span><span class="token function" >setState</span><span class="token punctuation" >(</span><span class="token punctuation" >{</span>
      notes<span class="token punctuation" >:</span> <span class="token keyword" >this</span><span class="token punctuation" >.</span>state<span class="token punctuation" >.</span>notes<span class="token punctuation" >.</span><span class="token function" >filter</span><span class="token punctuation" >(</span>note <span class="token operator" >=</span><span class="token operator" >></span> note<span class="token punctuation" >.</span>id <span class="token operator" >!==</span> id<span class="token punctuation" >)</span>
    <span class="token punctuation" >}</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span><span class="token punctuation" >;</span>
</div>
<div class="leanpub-insert">
  <span class="token function" >deleteNote</span><span class="token punctuation" >(</span>id<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
    NoteActions<span class="token punctuation" >.</span><span class="token keyword" >delete</span><span class="token punctuation" >(</span>id<span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span>
</div>
<div class="leanpub-delete">
  addNote <span class="token operator" >=</span> <span class="token punctuation" >(</span><span class="token punctuation" >)</span> <span class="token operator" >=</span><span class="token operator" >></span> <span class="token punctuation" >{</span>
    <span class="token keyword" >this</span><span class="token punctuation" >.</span><span class="token function" >setState</span><span class="token punctuation" >(</span><span class="token punctuation" >{</span>
      notes<span class="token punctuation" >:</span> <span class="token keyword" >this</span><span class="token punctuation" >.</span>state<span class="token punctuation" >.</span>notes<span class="token punctuation" >.</span><span class="token function" >concat</span><span class="token punctuation" >(</span><span class="token punctuation" >[</span><span class="token punctuation" >{</span>
        id<span class="token punctuation" >:</span> uuid<span class="token punctuation" >.</span><span class="token function" >v4</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span><span class="token punctuation" >,</span>
        task<span class="token punctuation" >:</span> <span class="token string" >'New task'</span>
      <span class="token punctuation" >}</span><span class="token punctuation" >]</span><span class="token punctuation" >)</span>
    <span class="token punctuation" >}</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span><span class="token punctuation" >;</span>
</div>
<div class="leanpub-insert">
  <span class="token function" >addNote</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
    NoteActions<span class="token punctuation" >.</span><span class="token function" >create</span><span class="token punctuation" >(</span><span class="token punctuation" >{</span>task<span class="token punctuation" >:</span> <span class="token string" >'New task'</span><span class="token punctuation" >}</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span>
</div>
<div class="leanpub-delete">
  editNote <span class="token operator" >=</span> <span class="token punctuation" >(</span>id<span class="token punctuation" >,</span> task<span class="token punctuation" >)</span> <span class="token operator" >=</span><span class="token operator" >></span> <span class="token punctuation" >{</span>
    <span class="token keyword" >const</span> notes <span class="token operator" >=</span> <span class="token keyword" >this</span><span class="token punctuation" >.</span>state<span class="token punctuation" >.</span>notes<span class="token punctuation" >.</span><span class="token function" >map</span><span class="token punctuation" >(</span>note <span class="token operator" >=</span><span class="token operator" >></span> <span class="token punctuation" >{</span>
      <span class="token keyword" >if</span><span class="token punctuation" >(</span>note<span class="token punctuation" >.</span>id <span class="token operator" >===</span> id  <span class="token operator" >&amp;&amp;</span> task<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
        note<span class="token punctuation" >.</span>task <span class="token operator" >=</span> task<span class="token punctuation" >;</span>
      <span class="token punctuation" >}</span>

      <span class="token keyword" >return</span> note<span class="token punctuation" >;</span>
    <span class="token punctuation" >}</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>

    <span class="token keyword" >this</span><span class="token punctuation" >.</span><span class="token function" >setState</span><span class="token punctuation" >(</span><span class="token punctuation" >{</span>notes<span class="token punctuation" >}</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span><span class="token punctuation" >;</span>
</div>
<div class="leanpub-insert">
  <span class="token function" >editNote</span><span class="token punctuation" >(</span>id<span class="token punctuation" >,</span> task<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
    NoteActions<span class="token punctuation" >.</span><span class="token function" >update</span><span class="token punctuation" >(</span><span class="token punctuation" >{</span>id<span class="token punctuation" >,</span> task<span class="token punctuation" >}</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span>
</div>
<span class="token punctuation" >}</span>
</code></pre>
<p>The application should work just like before now. As we alter <code>NoteStore</code> through actions, this leads to a cascade that causes our <code>App</code> state to update through <code>setState</code>. This in turn will cause the component to <code>render</code>. That&#39;s Flux&#39;s unidirectional flow in practice.</p>
<p>We actually have more code now than before, but that&#39;s okay. <code>App</code> is a little neater and it&#39;s going to be easier to develop as we&#39;ll soon see. Most importantly we have managed to implement the Flux architecture for our application.</p>
<h3 class="header"><a class="header-anchor" href="#what-s-the-point-" id="what-s-the-point-"></a><span class="text">What&#39;s the Point?</span><a class="header-anchor-select" href="#what-s-the-point-">#</a></h3>
<p>Even though integrating Alt took a lot of effort, it was not all in vain. Consider the following questions:</p>
<ol>
<li>Suppose we wanted to persist the notes within <code>localStorage</code>. Where would you implement that? It would be natural to plug that into our <code>NoteStore</code>. Alternatively we could do something more generic as we&#39;ll be doing next.</li>
<li>What if we had many components relying on the data? We would just consume <code>NoteStore</code> and display it, however we want.</li>
<li>What if we had many, separate Note lists for different types of tasks? We could set up another store for tracking these lists. That store could refer to actual Notes by id. We&#39;ll do something like this in the next chapter, as we generalize the approach.</li>
</ol>
<p>This is what makes Flux a strong architecture when used with React. It isn&#39;t hard to find answers to questions like these. Even though there is more code, it is easier to reason about. Given we are dealing with a unidirectional flow we have something that is simple to debug and test.</p>
<h2 class="header"><a class="header-anchor" href="#implementing-persistency-over-localstorage-" id="implementing-persistency-over-localstorage-"></a><span class="text">Implementing Persistency over <code>localStorage</code></span><a class="header-anchor-select" href="#implementing-persistency-over-localstorage-">#</a></h2>
<p>We will modify our implementation of <code>NoteStore</code> to persist the data on change. This way we don&#39;t lose our data after a refresh. One way to achieve this is to use <a href="https://developer.mozilla.org/en/docs/Web/API/Window/localStorage">localStorage</a>. It is a well supported feature that allows you to persist data to the browser.</p>
<h3 class="header"><a class="header-anchor" href="#understanding-localstorage-" id="understanding-localstorage-"></a><span class="text">Understanding <code>localStorage</code></span><a class="header-anchor-select" href="#understanding-localstorage-">#</a></h3>
<p><code>localStorage</code> has a sibling known as <code>sessionStorage</code>. Whereas <code>sessionStorage</code> loses its data when the browser is closed, <code>localStorage</code> retains its data. They both share <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API">the same API</a> as discussed below:</p>
<ul>
<li><code>storage.getItem(k)</code> - Returns the stored string value for the given key.</li>
<li><code>storage.removeItem(k)</code> - Removes the data matching the key.</li>
<li><code>storage.setItem(k, v)</code> - Stores the given value using the given key.</li>
<li><code>storage.clear()</code> - Empties the storage contents.</li>
</ul>
<p>Note that it is convenient to operate on the API using your browser developer tools. For instance, in Chrome you can see the state of the storages through the <em>Resources</em> tab. <em>Console</em> tab allows you to perform direct operations on the data. You can even use <code>storage.key</code> and <code>storage.key = &#39;value&#39;</code> shorthands for quick modifications.</p>
<p><code>localStorage</code> and <code>sessionStorage</code> can use up to 10 MB of data combined. Even though they are well supported, there are certain corner cases with interesting failures. These include running out of memory in Internet Explorer (fails silently) and failing altogether in Safari&#39;s private mode. It is possible to work around these glitches, though.</p>
<blockquote class="tip">You can support Safari in private mode by trying to write into <code>localStorage</code> first. If that fails, you can use Safari&#39;s in-memory store instead, or just let the user know about the situation. See <a href="https://stackoverflow.com/questions/14555347/html5-localstorage-error-with-safari-quota-exceeded-err-dom-exception-22-an">Stack Overflow</a> for details.</blockquote><h3 class="header"><a class="header-anchor" href="#implementing-a-wrapper-for-localstorage-" id="implementing-a-wrapper-for-localstorage-"></a><span class="text">Implementing a Wrapper for <code>localStorage</code></span><a class="header-anchor-select" href="#implementing-a-wrapper-for-localstorage-">#</a></h3>
<p>To keep things simple and manageable, we can implement a little wrapper for <code>storage</code>. It will wrap all of these complexities. The API expects strings.</p>
<p>As objects are convenient, we&#39;ll use <code>JSON.parse</code> and <code>JSON.stringify</code> for serialization. We need just <code>storage.get(k)</code> and <code>storage.set(k, v)</code> as seen in the implementation below:</p>
<p><strong>app/libs/storage.js</strong></p>
<pre><code class="lang-javascript"><span class="token keyword" >export</span> <span class="token keyword" >default</span> <span class="token punctuation" >{</span>
  <span class="token keyword" >get</span><span class="token punctuation" >(</span>k<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
    <span class="token keyword" >try</span> <span class="token punctuation" >{</span>
      <span class="token keyword" >return</span> JSON<span class="token punctuation" >.</span><span class="token function" >parse</span><span class="token punctuation" >(</span>localStorage<span class="token punctuation" >.</span><span class="token function" >getItem</span><span class="token punctuation" >(</span>k<span class="token punctuation" >)</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
    <span class="token punctuation" >}</span>
    <span class="token keyword" >catch</span><span class="token punctuation" >(</span>e<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
      <span class="token keyword" >return</span> <span class="token keyword" >null</span><span class="token punctuation" >;</span>
    <span class="token punctuation" >}</span>
  <span class="token punctuation" >}</span><span class="token punctuation" >,</span>
  <span class="token keyword" >set</span><span class="token punctuation" >(</span>k<span class="token punctuation" >,</span> v<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
    localStorage<span class="token punctuation" >.</span><span class="token function" >setItem</span><span class="token punctuation" >(</span>k<span class="token punctuation" >,</span> JSON<span class="token punctuation" >.</span><span class="token function" >stringify</span><span class="token punctuation" >(</span>v<span class="token punctuation" >)</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span>
<span class="token punctuation" >}</span><span class="token punctuation" >;</span>
</code></pre>
<p>The implementation could be generalized further. You could convert it into a factory (<code>storage =&gt; {...}</code>) and make it possible to swap the storage. Now we are stuck with <code>localStorage</code> unless we change the code.</p>
<blockquote class="tip">We&#39;re operating with <code>localStorage</code> directly to keep the implementation simple. An alternative would be to use <a href="https://github.com/mozilla/localForage">localForage</a> to hide all the complexity. You could even integrate it behind our interface.</blockquote><h3 class="header"><a class="header-anchor" href="#persisting-application-using-finalstore-" id="persisting-application-using-finalstore-"></a><span class="text">Persisting Application Using <code>FinalStore</code></span><a class="header-anchor-select" href="#persisting-application-using-finalstore-">#</a></h3>
<p>Besides this little utility, we&#39;ll need to adapt our application to use it. Alt provides a built-in store called <code>FinalStore</code> which is perfect for this purpose. We can persist the entire state of our application using <code>FinalStore</code>, bootstrapping, and snapshotting. <code>FinalStore</code> is a store that listens to all existing stores. Every time some store changes, <code>FinalStore</code> will know about it. This makes it ideal for persistency.</p>
<p>We can take a snapshot of the entire app state and push it to <code>localStorage</code> every time <code>FinalStore</code> changes. That solves one part of the problem. Bootstrapping solves the remaining part as <code>alt.bootstrap</code> allows us to set state of the all stores. The method doesn&#39;t emit events. To make our stores populate with the right state, we will need to call it before the components are rendered. In our case, we&#39;ll fetch the data from <code>localStorage</code> and invoke it to populate our stores.</p>
<blockquote class="tip">An alternative way would be to take a snapshot only when the window gets closed. There&#39;s a Window level <code>beforeunload</code> hook that could be used. The problem with this approach is that it is brittle. What if something unexpected happens and the hook doesn&#39;t get triggered for some reason? You&#39;ll lose data.</blockquote><p>In order to integrate this idea to our application, we will need to implement a little module to manage it. We take the possible initial data into account there and trigger the new logic.</p>
<p><em>app/libs/persist.js</em>  does the hard part. It will set up a <code>FinalStore</code>, deal with bootstrapping (restore data) and snapshotting (save data). I have included an escape hatch in the form of the <code>debug</code> flag. If it is set, the data won&#39;t get saved to <code>localStorage</code>. The reasoning is that by doing this, you can set the flag (<code>localStorage.setItem(&#39;debug&#39;, &#39;true&#39;)</code>), hit <code>localStorage.clear()</code> and refresh the browser to get a clean slate. The implementation below illustrates these ideas:</p>
<p><strong>app/libs/persist.js</strong></p>
<pre><code class="lang-javascript"><span class="token keyword" >import</span> makeFinalStore <span class="token keyword" >from</span> <span class="token string" >'alt-utils/lib/makeFinalStore'</span><span class="token punctuation" >;</span>

<span class="token keyword" >export</span> <span class="token keyword" >default</span> <span class="token keyword" >function</span><span class="token punctuation" >(</span>alt<span class="token punctuation" >,</span> storage<span class="token punctuation" >,</span> storeName<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
  <span class="token keyword" >const</span> finalStore <span class="token operator" >=</span> <span class="token function" >makeFinalStore</span><span class="token punctuation" >(</span>alt<span class="token punctuation" >)</span><span class="token punctuation" >;</span>

  <span class="token keyword" >try</span> <span class="token punctuation" >{</span>
    alt<span class="token punctuation" >.</span><span class="token function" >bootstrap</span><span class="token punctuation" >(</span>storage<span class="token punctuation" >.</span><span class="token keyword" >get</span><span class="token punctuation" >(</span>storeName<span class="token punctuation" >)</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span>
  <span class="token keyword" >catch</span><span class="token punctuation" >(</span>e<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
    console<span class="token punctuation" >.</span><span class="token function" >error</span><span class="token punctuation" >(</span><span class="token string" >'Failed to bootstrap data'</span><span class="token punctuation" >,</span> e<span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span>

  finalStore<span class="token punctuation" >.</span><span class="token function" >listen</span><span class="token punctuation" >(</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span> <span class="token operator" >=</span><span class="token operator" >></span> <span class="token punctuation" >{</span>
    <span class="token keyword" >if</span><span class="token punctuation" >(</span><span class="token operator" >!</span>storage<span class="token punctuation" >.</span><span class="token keyword" >get</span><span class="token punctuation" >(</span><span class="token string" >'debug'</span><span class="token punctuation" >)</span><span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
      storage<span class="token punctuation" >.</span><span class="token keyword" >set</span><span class="token punctuation" >(</span>storeName<span class="token punctuation" >,</span> alt<span class="token punctuation" >.</span><span class="token function" >takeSnapshot</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
    <span class="token punctuation" >}</span>
  <span class="token punctuation" >}</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
<span class="token punctuation" >}</span>
</code></pre>
<p>Finally, we need to trigger the persistency logic at initialization. We will need to pass the relevant data to it (Alt instance, storage, storage name) and off we go.</p>
<p><strong>app/index.jsx</strong></p>
<pre><code class="lang-javascript"><span class="token punctuation" >.</span><span class="token punctuation" >.</span><span class="token punctuation" >.</span>
<div class="leanpub-insert">
<span class="token keyword" >import</span> alt <span class="token keyword" >from</span> <span class="token string" >'./libs/alt'</span><span class="token punctuation" >;</span>
<span class="token keyword" >import</span> storage <span class="token keyword" >from</span> <span class="token string" >'./libs/storage'</span><span class="token punctuation" >;</span>
<span class="token keyword" >import</span> persist <span class="token keyword" >from</span> <span class="token string" >'./libs/persist'</span><span class="token punctuation" >;</span>
</div>

<div class="leanpub-insert">
<span class="token function" >persist</span><span class="token punctuation" >(</span>alt<span class="token punctuation" >,</span> storage<span class="token punctuation" >,</span> <span class="token string" >'app'</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
</div>

ReactDOM<span class="token punctuation" >.</span><span class="token function" >render</span><span class="token punctuation" >(</span><span class="token operator" >&lt;</span>App <span class="token operator" >/</span><span class="token operator" >></span><span class="token punctuation" >,</span> document<span class="token punctuation" >.</span><span class="token function" >getElementById</span><span class="token punctuation" >(</span><span class="token string" >'app'</span><span class="token punctuation" >)</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
</code></pre>
<p>If you try refreshing the browser now, the application should retain its state. The solution should scale with minimal effort if we add more stores to the system. Integrating a real back-end wouldn&#39;t be a problem. There are hooks in place for that now.</p>
<p>You could, for instance, pass the initial payload as a part of your HTML (universal rendering), load it up, and then persist the data to the back-end. You have a great deal of control over how to do this, and you can use <code>localStorage</code> as a backup if you want.</p>
<p>Universal rendering is a powerful technique that allows you to use React to improve the performance of your application while gaining SEO benefits. Rather than leaving all rendering to the front-end, we perform a part of it at the back-end side. We render the initial application markup at back-end and provide it to the user. React will pick that up. This can also include data that can be loaded to your application without having to perform extra queries.</p>
<blockquote class="warning">Our <code>persist</code> implementation isn&#39;t without its flaws. It is easy to end up in a situation where <code>localStorage</code> contains invalid data due to changes made to the data model. This brings you to the world of database schemas and migrations. There are no easy solutions. Regardless, this is something to keep in mind when developing something more sophisticated. The lesson here is that the more you inject state to your application, the more complicated it gets.</blockquote><h2 class="header"><a class="header-anchor" href="#using-the-altcontainer-" id="using-the-altcontainer-"></a><span class="text">Using the <code>AltContainer</code></span><a class="header-anchor-select" href="#using-the-altcontainer-">#</a></h2>
<p>The <a href="http://alt.js.org/docs/components/altContainer/">AltContainer</a> wrapper allows us to simplify connection logic greatly and cut down the amount of logic needed. To get started, install it using:</p>
<pre><code class="lang-bash">npm i alt-container --save
</code></pre>
<p>The implementation below illustrates how to bind it all together. Note how much code we can remove!</p>
<p><strong>app/components/App.jsx</strong></p>
<pre><code class="lang-javascript"><div class="leanpub-insert">
<span class="token keyword" >import</span> AltContainer <span class="token keyword" >from</span> <span class="token string" >'alt-container'</span><span class="token punctuation" >;</span>
</div>
<span class="token keyword" >import</span> React <span class="token keyword" >from</span> <span class="token string" >'react'</span><span class="token punctuation" >;</span>
<span class="token keyword" >import</span> Notes <span class="token keyword" >from</span> <span class="token string" >'./Notes.jsx'</span><span class="token punctuation" >;</span>
<span class="token keyword" >import</span> NoteActions <span class="token keyword" >from</span> <span class="token string" >'../actions/NoteActions'</span><span class="token punctuation" >;</span>
<span class="token keyword" >import</span> NoteStore <span class="token keyword" >from</span> <span class="token string" >'../stores/NoteStore'</span><span class="token punctuation" >;</span>

<span class="token keyword" >export</span> <span class="token keyword" >default</span> <span class="token keyword" >class</span> <span class="token class-name" >App</span> <span class="token keyword" >extends</span> <span class="token class-name" >React<span class="token punctuation" >.</span>Component</span> <span class="token punctuation" >{</span>
<div class="leanpub-delete">
  <span class="token function" >constructor</span><span class="token punctuation" >(</span>props<span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
    <span class="token keyword" >super</span><span class="token punctuation" >(</span>props<span class="token punctuation" >)</span><span class="token punctuation" >;</span>

    <span class="token keyword" >this</span><span class="token punctuation" >.</span>state <span class="token operator" >=</span> NoteStore<span class="token punctuation" >.</span><span class="token function" >getState</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span>
  <span class="token function" >componentDidMount</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
    NoteStore<span class="token punctuation" >.</span><span class="token function" >listen</span><span class="token punctuation" >(</span><span class="token keyword" >this</span><span class="token punctuation" >.</span>storeChanged<span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span>
  <span class="token function" >componentWillUnmount</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
    NoteStore<span class="token punctuation" >.</span><span class="token function" >unlisten</span><span class="token punctuation" >(</span><span class="token keyword" >this</span><span class="token punctuation" >.</span>storeChanged<span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span>
  storeChanged <span class="token operator" >=</span> <span class="token punctuation" >(</span>state<span class="token punctuation" >)</span> <span class="token operator" >=</span><span class="token operator" >></span> <span class="token punctuation" >{</span>
    <span class="token comment" spellcheck="true">// Without a property initializer `this` wouldn't</span>
    <span class="token comment" spellcheck="true">// point at the right context (defaults to `undefined` in strict mode).</span>
    <span class="token keyword" >this</span><span class="token punctuation" >.</span><span class="token function" >setState</span><span class="token punctuation" >(</span>state<span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span><span class="token punctuation" >;</span>
</div>
  <span class="token function" >render</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span> <span class="token punctuation" >{</span>
<div class="leanpub-delete">
    <span class="token keyword" >const</span> notes <span class="token operator" >=</span> <span class="token keyword" >this</span><span class="token punctuation" >.</span>state<span class="token punctuation" >.</span>notes<span class="token punctuation" >;</span>
</div>

    <span class="token keyword" >return</span> <span class="token punctuation" >(</span>
      <span class="token operator" >&lt;</span>div<span class="token operator" >></span>
        <span class="token operator" >&lt;</span>button className<span class="token operator" >=</span><span class="token string" >"add-note"</span> onClick<span class="token operator" >=</span><span class="token punctuation" >{</span><span class="token keyword" >this</span><span class="token punctuation" >.</span>addNote<span class="token punctuation" >}</span><span class="token operator" >></span><span class="token operator" >+</span><span class="token operator" >&lt;</span><span class="token operator" >/</span>button<span class="token operator" >></span>
<div class="leanpub-delete">
        <span class="token operator" >&lt;</span>Notes notes<span class="token operator" >=</span><span class="token punctuation" >{</span>notes<span class="token punctuation" >}</span>
          onEdit<span class="token operator" >=</span><span class="token punctuation" >{</span><span class="token keyword" >this</span><span class="token punctuation" >.</span>editNote<span class="token punctuation" >}</span>
          onDelete<span class="token operator" >=</span><span class="token punctuation" >{</span><span class="token keyword" >this</span><span class="token punctuation" >.</span>deleteNote<span class="token punctuation" >}</span> <span class="token operator" >/</span><span class="token operator" >></span>
</div>
<div class="leanpub-insert">
        <span class="token operator" >&lt;</span>AltContainer
          stores<span class="token operator" >=</span><span class="token punctuation" >{</span><span class="token punctuation" >[</span>NoteStore<span class="token punctuation" >]</span><span class="token punctuation" >}</span>
          inject<span class="token operator" >=</span><span class="token punctuation" >{</span><span class="token punctuation" >{</span>
            notes<span class="token punctuation" >:</span> <span class="token punctuation" >(</span><span class="token punctuation" >)</span> <span class="token operator" >=</span><span class="token operator" >></span> NoteStore<span class="token punctuation" >.</span><span class="token function" >getState</span><span class="token punctuation" >(</span><span class="token punctuation" >)</span><span class="token punctuation" >.</span>notes
          <span class="token punctuation" >}</span><span class="token punctuation" >}</span>
        <span class="token operator" >></span>
          <span class="token operator" >&lt;</span>Notes onEdit<span class="token operator" >=</span><span class="token punctuation" >{</span><span class="token keyword" >this</span><span class="token punctuation" >.</span>editNote<span class="token punctuation" >}</span> onDelete<span class="token operator" >=</span><span class="token punctuation" >{</span><span class="token keyword" >this</span><span class="token punctuation" >.</span>deleteNote<span class="token punctuation" >}</span> <span class="token operator" >/</span><span class="token operator" >></span>
        <span class="token operator" >&lt;</span><span class="token operator" >/</span>AltContainer<span class="token operator" >></span>
</div>
      <span class="token operator" >&lt;</span><span class="token operator" >/</span>div<span class="token operator" >></span>
    <span class="token punctuation" >)</span><span class="token punctuation" >;</span>
  <span class="token punctuation" >}</span>
  <span class="token punctuation" >.</span><span class="token punctuation" >.</span><span class="token punctuation" >.</span>
<span class="token punctuation" >}</span>
</code></pre>
<p>The <code>AltContainer</code> allows us to bind data to its immediate children. In this case, it injects the <code>notes</code> property in to <code>Notes</code>. The pattern allows us to set up arbitrary connections to multiple stores and manage them. You can find another possible approach at the appendix about decorators.</p>
<p>Integrating the <code>AltContainer</code> tied this component to Alt. If you wanted something forward-looking, you could push it into a component of your own. That facade would hide Alt and allow you to replace it with something else later on.</p>
<h2 class="header"><a class="header-anchor" href="#dispatching-in-alt" id="dispatching-in-alt"></a><span class="text">Dispatching in Alt</span><a class="header-anchor-select" href="#dispatching-in-alt">#</a></h2>
<p>Even though you can get far without ever using Flux dispatcher, it can be useful to know something about it. Alt provides two ways to use it. If you want to log everything that goes through your <code>alt</code> instance, you can use a snippet, such as <code>alt.dispatcher.register(console.log.bind(console))</code>. Alternatively you could trigger <code>this.dispatcher.register(...)</code> at a store constructor. These mechanisms allow you to implement effective logging.</p>
<h2 class="header"><a class="header-anchor" href="#alternative-implementations" id="alternative-implementations"></a><span class="text">Alternative Implementations</span><a class="header-anchor-select" href="#alternative-implementations">#</a></h2>
<p>Even though we ended up using Alt in our implementation, it&#39;s not the only option. In order to benchmark various architectures, I&#39;ve implemented the same application using different techniques. I&#39;ve compared them briefly below:</p>
<ul>
<li><a href="http://rackt.org/redux/">Redux</a> is a Flux inspired architecture that was designed with hot loading as its primary constraint. Redux operates based on a single state tree. The state of the tree is manipulated using <em>pure functions</em> known as reducers. Even though there&#39;s some boilerplate code, Redux forces you to dig into functional programming. The implementation is quite close to the Alt based one. - <a href="https://github.com/survivejs/redux-demo">Redux demo</a></li>
<li>Compared to Redux, <a href="http://www.cerebraljs.com/">Cerebral</a> had a different starting point. It was developed to provide insight on <em>how</em> the application changes its state. Cerebral provides more opinionated way to develop, and as a result, comes with more batteries included. - <a href="https://github.com/survivejs/cerebral-demo">Cerebral demo</a></li>
<li><a href="https://mweststrate.github.io/mobservable/">Mobservable</a> allows you to make your data structures observable. The structures can then be connected with React components so that whenever the structures update, so do the React components. Given real references between structures can be used, the Kanban implementation is surprisingly simple. - <a href="https://github.com/survivejs/mobservable-demo">Mobservable demo</a></li>
</ul>
<h2 class="header"><a class="header-anchor" href="#relay-" id="relay-"></a><span class="text">Relay?</span><a class="header-anchor-select" href="#relay-">#</a></h2>
<p>Compared to Flux, Facebook&#39;s <a href="https://facebook.github.io/react/blog/2015/02/20/introducing-relay-and-graphql.html">Relay</a> improves on the data fetching department. It allows you to push data requirements to the view level. It can be used standalone or with Flux depending on your needs.</p>
<p>Given it&#39;s still largely untested technology, we won&#39;t be covering it in this book yet. Relay comes with special requirements of its own (GraphQL compatible API). Only time will tell how it gets adopted by the community.</p>
<h2 class="header"><a class="header-anchor" href="#conclusion" id="conclusion"></a><span class="text">Conclusion</span><a class="header-anchor-select" href="#conclusion">#</a></h2>
<p>In this chapter, you saw how to port our simple application to use Flux architecture. In the process we learned about basic concepts of Flux. Now we are ready to start adding more functionality to our application.</p>
</div><div class="social-links"><blockquote class="tip">If you enjoyed this chapter consider subscribing to the mailing list below or following <a href="https://twitter.com/survivejs">@survivejs</a> for occasional updates. There is also <a href="/atom.xml">RSS</a> available for old beards (no pun intended).</blockquote><form action="//jster.us7.list-manage.com/subscribe/post?u=ed40c0084a0c5ba31b3365d65&amp;id=b853b8e786" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate=""><div id="mc_embed_signup_scroll"><div class="mc-field-group"><input type="email" placeholder="Email" value="" name="EMAIL" class="required email" id="mce-EMAIL"/></div><div style="position:absolute;left:-5000px;"><input type="text" name="b_ed40c0084a0c5ba31b3365d65_b853b8e786" tabindex="-1" value=""/></div><div class="clear"><input type="submit" class="btn button" style="margin-top:1em;margin-bottom:1em;line-height:2em;" value="Subscribe" name="subscribe" id="mc-embedded-subscribe"/></div></div></form></div><div class="new-prevnext"><div class="new-prevnext__prev"><div class="new-prevnext__bg" style="background-image:url(/images/notes.jpg);"></div><span class="new-prevnext__info">Previous chapter</span><a class="new-prevnext__link" href="/webpack_react/implementing_notes">Implementing a Basic Note Application</a></div><div class="new-prevnext__next"><div class="new-prevnext__bg" style="background-image:url(/images/kanban_photo.jpg);"></div><span class="new-prevnext__info">Next chapter</span><a class="new-prevnext__link" href="/webpack_react/from_notes_to_kanban">From Notes to Kanban</a></div></div><div id="disqus_thread"></div></div><a class="next-page" href="/webpack_react/from_notes_to_kanban" title="From Notes to Kanban"></a><a class="previous-page" href="/webpack_react/implementing_notes" title="Implementing a Basic Note Application"></a></div><script type="text/javascript">var disqus_shortname = 'survivejs';(function() {var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script></div><div class="nav__wrapper"><input type="checkbox" class="nav__toggle" id="nav__toggle"/><label class="nav__toggle-label" for="nav__toggle"></label><nav class="nav"><div class="nav__link"><a class="" href="/">Home</a></div><div class="nav__link"><a class="" href="/blog">Read the blog</a></div><div class="nav__link"><a class="" href="https://leanpub.com/survivejs_webpack">Buy the full ebook</a></div><div class="nav__link"><a class="" href=""></a></div><div class="nav__link"><a class="" href="https://twitter.com/survivejs">@survivejs</a></div></nav></div><div class="right ribbon github-fork-ribbon-wrapper"><div class="github-fork-ribbon" style="background-color:black;"><a href="https://github.com/survivejs/webpack_react/issues/new?title=React and Flux - " target="_blank">Submit feedback</a></div></div><footer><div class="footer-wrapper"><div class="footer-social"><h3>Social</h3><ul><li><a href="https://twitter.com/survivejs" target="_blank">@survivejs</a></li><li><a href="http://eepurl.com/bth1v5" target="_blank">Mailing List</a></li><li><a href="https://gitter.im/survivejs/webpack_react" target="_blank">Gitter Chat</a></li><li><a href="https://github.com/survivejs/webpack_react" target="_blank">GitHub</a></li><li><a href="/atom.xml" target="_blank">Blog RSS</a></li><li><a href="http://goo.gl/forms/OWdGIOdHm9" target="_blank">Contact</a></li></ul></div><div class="footer-blog"><h3>From the Blog</h3><ul class="blog-teasers"><li><a class="blog-teaser" href="/blog/towards-common-components">Towards a Common Component Definition</a></li><li><a class="blog-teaser" href="/blog/survivejs200-rc3">SurviveJS - Webpack and React v2.0.0-rc3</a></li><li><a class="blog-teaser" href="/blog/survivejs200-rc2">SurviveJS - Webpack and React v2.0.0-rc2</a></li><li><a class="blog-teaser" href="/blog/survivejs200-rc1">SurviveJS - Webpack and React v2.0.0-rc1</a></li><li><a class="blog-teaser" href="/blog/codemod-interview">Codemod - Refactoring Code Programmatically - Interview with Ramana Venkata</a></li><li><a class="blog-teaser" href="/blog/2015-recap">2015 Recap</a></li><li><a class="blog-teaser" href="/blog/survivejs200-beta2">SurviveJS - Webpack and React v2.0.0-beta2</a></li><li><a class="blog-teaser" href="/blog/whitestormjs-interview">WhitestormJS - Three.js Based Game Engine - Interview with Alexander Buzin</a></li><li><a class="blog-teaser" href="/blog/survivejs1915">SurviveJS - Webpack and React v1.9.15</a></li><li><a class="blog-teaser" href="/blog/react-indie-bundle">React Indie Bundle - Summary</a></li></ul></div></div></footer><div><script type="text/javascript">
          ((window.gitter = {}).chat = {}).options = {
            room: 'survivejs/webpack_react'
          };
        </script>,<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async="" defer=""></script></div></main></body></html>